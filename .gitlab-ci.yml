stages:
 - build
 - .post

test build job:
  image: docker:latest
  stage: build
  only:
    - develop@LHMS/SystemReports
  tags:
    - develop
  variables:
    SECRET : $Secret
    EMAILFROM : $EmailFrom
    SMTPHOST : $SmtpHost
    SMTPPORT : $SmtpPort
    SMTPUSER : $SmtpUser
    SMTPPASS : $SmtpPass
    STAGINGCONNECTSTRING : $StagingConnectString
  script:
    - sed -i 's/"$Secret"/$Secret/g' appsettings.Staging.json
    - sed -i 's/"$Emailfrom"/$EmailFrom/g' appsettings.Staging.json
    - sed -i 's/"$SmtpHost"/$SmtpHost/g' appsettings.Staging.json
    - sed -i 's/"$SmptPort"/$SmtpPort/g' appsettings.Staging.json
    - sed -i 's/"$SmtpUser"/$SmtpUser/g' appsettings.Staging.json
    - sed -i 's/"$SmtpPass"/$SmtpPass/g' appsettings.Staging.json
    - sed -i 's/"$StagingConnectString"/$StagingConnectString/g' appsettings.Staging.json
    - docker build -f test.Dockerfile -t systemreports .

test deploy job:
  stage: .post
  only:
    - develop@LHMS/SystemReports
  trigger:
    project: LHMS/LHMS
    branch: develop

prod build job:
    image: docker:latest
    stage: build
    only:
      - master@LHMS/SystemReports
    tags:
      - production
    variables:
      SECRET : $Secret
      EMAILFROM : $EmailFrom
      SMTPHOST : $SmtpHost
      SMTPPORT : $SmtpPort
      SMTPUSER : $SmtpUser
      SMTPPASS : $SmtpPass
      PROD_CONNECT_STRING : $ProdConnectString

    script:
      - docker build -f prod.Dockerfile -t systemreports .

prod deploy job:
  stage: .post
  only:
    - master@LHMS/SystemReports
  trigger:
    project: LHMS/LHMS
    branch: master
