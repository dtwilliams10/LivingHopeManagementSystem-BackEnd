stages:
 - build
build:
  image: docker:latest
  stage: build
  script:
    - docker build -t lhmsapi .

stages:
 - build
 - deploy

test build job:
  image: docker:latest
  stage: build
  only:
    - develop@LHMS/LHMS-API
  tags: 
    - develop
  script:
    - docker build -t lhmsapi .

test deploy job:
  image:
    name: docker/compose:1.22.0
    entrypoint: ["/bin/sh", "-c"]
  stage: deploy
  script:
    - docker network disconnect lhms-frontend_webappnetwork proxy
    - docker-compose -f "docker-compose.test.yml" down
    - docker-compose -f "docker-compose.test.yml" up -d --build
    - docker network connect lhms-frontend_webappnetwork proxy
  environment:
    name: staging
    url: https://test.lhmsapi.dtwilliams10.com
  only:
    - develop@LHMS/LHMS-FrontEnd
  tags:
    - develop

prod build job:
    image: docker:latest
    stage: build
    only:
      - master@LHMS/LHMS-API
    tags: 
      - production
    script:
      - docker build -t lhmsapi .

prod deploy job:
 image:
  name: docker/compose:1.22.0
  entrypoint: ["/bin/sh", "-c"]
 stage: deploy
 script:
  - docker network disconnect lhms-frontend_webappnetwork proxy
  - docker-compose -f "docker-compose.prod.yml" down
  - docker-compose -f "docker-compose.prod.yml" up -d --build
  - docker network connect lhms-frontend_webappnetwork proxy
 environment:
  name: staging
  url: https://lhmsapi.dtwilliams10.com
 only:
  - master@LHMS/LHMS-API
 tags:
  - production